<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyLink LAN Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
html,body,#app{height:100%;margin:0;}
.iframe-fill{width:100%;height:100%;border:0;}
.thin-scroll::-webkit-scrollbar{height:6px;width:6px;}
.thin-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:6px;}
.drawer{transition: transform 0.3s;}
.drawer-hidden{transform: translateX(100%);}
.hidden{display:none;}
button:disabled{opacity:0.5;cursor:not-allowed;}
#groupRequests{position:fixed;top:16px;right:16px;z-index:50;width:300px;}
.requestCard{background:#1e293b;color:#fff;padding:8px;margin-bottom:4px;border-radius:4px;display:flex;justify-content:space-between;align-items:center;}
#pinnedList{position:fixed;bottom:16px;left:16px;z-index:20;display:flex;flex-direction:column;gap:4px;}
#chatContainer{max-height:180px;overflow:auto;}
.groupPopupBg{position:fixed;inset:0;background:black/50;z-index:50;display:flex;justify-content:center;align-items:center;}
.groupPopup{background:#1e293b;color:#fff;padding:16px;border-radius:6px;width:280px;max-height:80%;overflow:auto;display:flex;flex-direction:column;gap:8px;}
.groupMember{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;background:#334155;border-radius:4px;}
.groupMember button{background:#ef4444;color:#fff;padding:0 6px;border-radius:4px;font-size:12px;}
</style>
</head>
<body class="bg-slate-900 text-slate-100">
<div id="app" class="h-full flex flex-col">

<!-- Top Bar -->
<div class="flex items-center gap-2 p-2 bg-slate-800/60 border-b border-slate-700 flex-wrap">
  <span class="text-sm text-slate-300">Username</span>
  <input id="username" class="px-2 py-1 rounded bg-slate-700 text-slate-100 w-32"/>
  <button id="saveUserBtn" class="px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-sm">Save</button>
  <button id="toggleContactsBtn" class="px-2 py-1 rounded bg-slate-600 hover:bg-slate-500 text-sm ml-auto">Contacts</button>
  <button id="toggleNotesBtn" class="px-2 py-1 rounded bg-slate-600 hover:bg-slate-500 text-sm ml-2">Notes</button>
  <button id="fullscreenBtn" class="px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-sm ml-2">Fullscreen</button>
</div>

<div class="flex flex-1 overflow-hidden">
  <!-- Notes Pane -->
  <div id="notesPane" class="w-80 bg-slate-800/50 border-r border-slate-700 p-3 flex flex-col gap-3">
    <div class="text-lg font-semibold">Notes (Autosaved)</div>
    <textarea id="notes" class="flex-1 rounded p-2 bg-slate-700 text-slate-100 thin-scroll"></textarea>
  </div>

  <!-- Center iframe & chat -->
  <div class="flex-1 flex flex-col relative">
    <div class="p-2 bg-slate-800/60 border-b border-slate-700 flex items-center gap-2 flex-wrap">
      <input id="urlInput" class="flex-1 px-2 py-1 rounded bg-slate-700 text-slate-100" placeholder="https://example.com"/>
      <button id="goBtn" class="px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500">Go</button>
      <button id="pinBtn" class="px-2 py-1 rounded bg-yellow-600 hover:bg-yellow-500">Pin</button>
      <button id="openTabBtn" class="px-2 py-1 rounded bg-sky-600 hover:bg-sky-500">Open in New Tab</button>
    </div>
    <div id="iframeWrapper" class="flex-1 bg-slate-900 relative flex flex-col">
      <iframe id="browserFrame" class="iframe-fill" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
      <div class="flex-1 flex flex-col bg-slate-800/60 border-t border-slate-700 p-2">
        <div class="flex justify-between items-center mb-2">
          <div class="flex gap-2 items-center">
            <button class="chatSelectBtn px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-sm" data-chat="Global">Global</button>
            <span id="onlineUsers" class="text-sm text-emerald-300"></span>
          </div>
          <span id="activeChatName" class="text-sm text-slate-300">Global</span>
        </div>
        <div id="chatContainer" class="flex-1 flex flex-col overflow-auto thin-scroll mb-2"></div>
        <div class="flex items-center gap-2 mb-2">
          <input id="messageInput" placeholder="Type message and press Enter" class="flex-1 px-2 py-1 rounded bg-slate-700 text-slate-100"/>
          <button id="sendBtn" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500">Send</button>
          <button id="clearChatBtn" class="px-3 py-1 rounded bg-rose-600 hover:bg-rose-500">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contacts Drawer -->
  <div id="contactsDrawer" class="w-64 bg-slate-800/50 border-l border-slate-700 p-3 flex flex-col gap-3 drawer drawer-hidden">
    <div class="flex items-center justify-between mb-2">
      <span class="text-lg font-semibold">Contacts</span>
      <button id="createGroupBtn" class="px-2 py-1 rounded bg-sky-600 hover:bg-sky-500 text-sm">New Group</button>
    </div>
    <div class="flex gap-2 mb-2">
      <input id="addContactInput" placeholder="Add contact" class="flex-1 px-2 py-1 rounded bg-slate-700 text-slate-100 text-sm"/>
      <button id="addContactBtn" class="px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-sm">Add</button>
    </div>
    <div id="contactsList" class="flex-1 overflow-auto thin-scroll flex flex-col gap-2"></div>
    <div class="mt-2">
      <span class="text-sm text-slate-300">Groups</span>
      <div id="groupList" class="flex flex-col gap-1 mt-1"></div>
    </div>
  </div>
</div>

<!-- Pins -->
<div id="pinnedList"></div>

<!-- Group join requests container -->
<div id="groupRequests"></div>

<script>
// === State & Storage ===
const LS_KEYS={username:'studylink_username',contacts:'studylink_contacts',groups:'studylink_groups',notes:'studylink_notes',chats:'studylink_chats'};
let username=localStorage.getItem(LS_KEYS.username)||'anon';
let contacts=JSON.parse(localStorage.getItem(LS_KEYS.contacts)||'[]');
let groups=JSON.parse(localStorage.getItem(LS_KEYS.groups)||'[]');
let notes=localStorage.getItem(LS_KEYS.notes)||'';
let chats=JSON.parse(localStorage.getItem(LS_KEYS.chats)||'{}');
let activeChat='Global';
let activeGroup=null;

// === Elements ===
const usernameInput=document.getElementById('username');
const saveUserBtn=document.getElementById('saveUserBtn');
const chatContainer=document.getElementById('chatContainer');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const clearChatBtn=document.getElementById('clearChatBtn');
const onlineUsersEl=document.getElementById('onlineUsers');
const contactsDrawer=document.getElementById('contactsDrawer');
const toggleContactsBtn=document.getElementById('toggleContactsBtn');
const toggleNotesBtn=document.getElementById('toggleNotesBtn');
const contactsList=document.getElementById('contactsList');
const createGroupBtn=document.getElementById('createGroupBtn');
const groupList=document.getElementById('groupList');
const activeChatName=document.getElementById('activeChatName');
const notesPane=document.getElementById('notesPane');
const notesEl=document.getElementById('notes');

// === Local Storage ===
function saveLocal(){
  localStorage.setItem(LS_KEYS.username,username);
  localStorage.setItem(LS_KEYS.contacts,JSON.stringify(contacts));
  localStorage.setItem(LS_KEYS.groups,JSON.stringify(groups));
  localStorage.setItem(LS_KEYS.notes,notesEl.value);
  localStorage.setItem(LS_KEYS.chats,JSON.stringify(chats));
}
notesEl.value=notes;
notesEl.addEventListener('input',saveLocal);

// === Chat ===
function appendChat(user,msg,chatName=activeChat){
  if(!chats[chatName]) chats[chatName]=[];
  chats[chatName].push({user,msg});
  if(chats[chatName].length>100) chats[chatName].shift();
  if(chatName===activeChat) renderChat();
  saveLocal();
}
function renderChat(){
  chatContainer.innerHTML='';
  activeChatName.textContent=activeChat;
  const msgs=chats[activeChat]||[];
  msgs.forEach(m=>{
    const d=document.createElement('div');
    const ts=new Date().toLocaleTimeString();
    d.className='mb-1';
    d.innerHTML=`<div class="text-xs text-slate-400">${ts} â€” <span class="text-emerald-300">${m.user}</span></div><div class="text-slate-100">${m.msg}</div>`;
    chatContainer.appendChild(d);
  });
  chatContainer.scrollTop=chatContainer.scrollHeight;
}
clearChatBtn.addEventListener('click',()=>{
  if(confirm('Clear chat?')){chats[activeChat]=[]; renderChat(); saveLocal();}
});

// === Contacts ===
function renderContacts(){
  contactsList.innerHTML='';
  contacts.forEach(c=>{
    const el=document.createElement('div'); el.className='flex items-center justify-between bg-slate-700/50 p-2 rounded';
    el.innerHTML=`<span>${c}</span><div><button class="connectBtn px-2 py-1 rounded bg-emerald-600 text-sm">Connect</button> <button class="delBtn px-2 py-1 rounded bg-rose-600 text-sm">X</button></div>`;
    contactsList.appendChild(el);
    el.querySelector('.connectBtn').addEventListener('click',()=>console.log('Connect to',c));
    el.querySelector('.delBtn').addEventListener('click',()=>{contacts.splice(contacts.indexOf(c),1); saveLocal(); renderContacts();});
  });
}
document.getElementById('addContactBtn').addEventListener('click',()=>{
  const val=document.getElementById('addContactInput').value.trim();
  if(val&&!contacts.includes(val)){contacts.push(val); document.getElementById('addContactInput').value=''; saveLocal(); renderContacts();}
});

// === Groups ===
function renderGroups(){
  groupList.innerHTML='';
  groups.forEach(g=>{
    const el=document.createElement('div'); el.className='flex items-center justify-between bg-slate-700/50 p-2 rounded';
    el.innerHTML=`<span>${g.name}</span><div class="flex gap-1"><button class="openBtn px-2 py-1 rounded bg-sky-600 text-sm">Open</button><button class="manageBtn px-2 py-1 rounded bg-indigo-600 text-sm">Manage</button><button class="delBtn px-2 py-1 rounded bg-rose-600 text-sm">X</button></div>`;
    groupList.appendChild(el);
    el.querySelector('.openBtn').addEventListener('click',()=>{activeChat=g.name; activeGroup=g; renderChat();});
    el.querySelector('.manageBtn').addEventListener('click',()=>openManageGroupUI(g));
    el.querySelector('.delBtn').addEventListener('click',()=>{if(confirm('Delete group?')){groups.splice(groups.indexOf(g),1); saveLocal(); renderGroups();}});
  });
}

// === Manage Group UI (Old Style) ===
function openManageGroupUI(group){
  const popupBg=document.createElement('div'); popupBg.className='groupPopupBg';
  const popup=document.createElement('div'); popup.className='groupPopup';
  const title=document.createElement('div'); title.textContent=`Manage "${group.name}"`; title.className='text-lg font-semibold';
  const memberList=document.createElement('div'); memberList.className='flex flex-col gap-1';
  function refreshMembers(){
    memberList.innerHTML='';
    group.members.forEach(m=>{
      const mEl=document.createElement('div'); mEl.className='groupMember';
      mEl.innerHTML=`<span>${m}</span><button>X</button>`;
      mEl.querySelector('button').addEventListener('click',()=>{group.members.splice(group.members.indexOf(m),1); saveLocal(); refreshMembers();});
      memberList.appendChild(mEl);
    });
  }
  refreshMembers();
  const addDiv=document.createElement('div'); addDiv.className='flex gap-1 mt-2';
  const input=document.createElement('input'); input.placeholder='Add member'; input.className='flex-1 px-2 py-1 rounded bg-slate-700 text-slate-100 text-sm';
  const addBtn=document.createElement('button'); addBtn.textContent='Add'; addBtn.className='px-2 py-1 rounded bg-emerald-600 text-sm';
  addBtn.addEventListener('click',()=>{const val=input.value.trim(); if(val&&!group.members.includes(val)){group.members.push(val); input.value=''; saveLocal(); refreshMembers();}});
  addDiv.append(input,addBtn);
  const closeBtn=document.createElement('button'); closeBtn.textContent='Close'; closeBtn.className='px-2 py-1 rounded bg-slate-600 mt-2'; closeBtn.addEventListener('click',()=>popupBg.remove());
  popup.append(title,memberList,addDiv,closeBtn);
  popupBg.appendChild(popup); document.body.appendChild(popupBg);
}

// === Create New Group UI (Old Style) ===
createGroupBtn.addEventListener('click',()=>{
  const popupBg=document.createElement('div'); popupBg.className='groupPopupBg';
  const popup=document.createElement('div'); popup.className='groupPopup';
  const title=document.createElement('div'); title.textContent='Create New Group'; title.className='text-lg font-semibold';
  const nameInput=document.createElement('input'); nameInput.placeholder='Group Name'; nameInput.className='px-2 py-1 rounded bg-slate-700 text-slate-100';
  const memberList=document.createElement('div'); memberList.className='flex flex-col gap-1 max-h-40 overflow-auto thin-scroll';
  let tempMembers=[username];
  function refreshMembers(){
    memberList.innerHTML='';
    tempMembers.forEach(m=>{
      const mEl=document.createElement('div'); mEl.className='groupMember';
      mEl.innerHTML=`<span>${m}</span><button>X</button>`;
      mEl.querySelector('button').addEventListener('click',()=>{tempMembers.splice(tempMembers.indexOf(m),1); refreshMembers();});
      memberList.appendChild(mEl);
    });
  }
  refreshMembers();
  const addDiv=document.createElement('div'); addDiv.className='flex gap-1 mt-2';
  const input=document.createElement('input'); input.placeholder='Add member'; input.className='flex-1 px-2 py-1 rounded bg-slate-700 text-slate-100 text-sm';
  const addBtn=document.createElement('button'); addBtn.textContent='Add'; addBtn.className='px-2 py-1 rounded bg-emerald-600 text-sm';
  addBtn.addEventListener('click',()=>{const val=input.value.trim(); if(val&&!tempMembers.includes(val)){tempMembers.push(val); input.value=''; refreshMembers();}});
  addDiv.append(input,addBtn);
  const createBtn=document.createElement('button'); createBtn.textContent='Create'; createBtn.className='px-2 py-1 rounded bg-sky-600 mt-2';
  createBtn.addEventListener('click',()=>{
    const gname=nameInput.value.trim(); if(!gname){alert('Enter name'); return;}
    if(groups.find(g=>g.name===gname)){alert('Group exists'); return;}
    groups.push({name:gname,members:tempMembers.slice()}); saveLocal(); renderGroups(); popupBg.remove();
  });
  const closeBtn=document.createElement('button'); closeBtn.textContent='Cancel'; closeBtn.className='px-2 py-1 rounded bg-slate-600 mt-2'; closeBtn.addEventListener('click',()=>popupBg.remove());
  popup.append(title,nameInput,memberList,addDiv,createBtn,closeBtn); popupBg.appendChild(popup); document.body.appendChild(popupBg);
});

// === Chat select buttons ===
document.querySelectorAll('.chatSelectBtn').forEach(btn=>btn.addEventListener('click',()=>{activeChat=btn.dataset.chat; renderChat();}));

// === Send Message ===
sendBtn.addEventListener('click',()=>{const m=messageInput.value.trim(); if(!m)return; appendChat(username,m); messageInput.value='';});
messageInput.addEventListener('keypress',e=>{if(e.key==='Enter'){sendBtn.click();}});

// === Toggle drawers ===
toggleContactsBtn.addEventListener('click',()=>contactsDrawer.classList.toggle('drawer-hidden'));
toggleNotesBtn.addEventListener('click',()=>notesPane.classList.toggle('hidden'));

// === Initialize ===
usernameInput.value=username;
saveUserBtn.addEventListener('click',()=>{username=usernameInput.value.trim(); saveLocal();});
renderContacts(); renderGroups(); renderChat();
</script>
</body>
</html>
